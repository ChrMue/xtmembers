<?php
function datesortasc($a, $b)
{
	if (array_key_exists("dateOfBirth", $a[0]["raw"]) && array_key_exists("dateOfBirth", $b[0]["raw"]))
	{
		if ((is_numeric($a[0]["raw"]["dateOfBirth"])) && (is_numeric($b[0]["raw"]["dateOfBirth"])))
		{
			$aday = (int)date("d", $a[0]["raw"]["dateOfBirth"]);
			$bday = (int)date("d", $b[0]["raw"]["dateOfBirth"]);
			if ($aday == $bday) 
			{
				$ayear = (int)date("Y", $a[0]["raw"]["dateOfBirth"]);
				$byear = (int)date("Y", $b[0]["raw"]["dateOfBirth"]);
				if ($ayear == $byear) 
				{
					return 0;
				}
				return ($ayear < $byear) ? -1 : 1;
			}
			return ($aday < $bday) ? -1 : 1;
		}
	}
	return 0;
}
function datesortdesc($a, $b)
{
	if (array_key_exists("dateOfBirth", $a[0]["raw"]) && array_key_exists("dateOfBirth", $b[0]["raw"]))
	{
		if ((is_numeric($a[0]["raw"]["dateOfBirth"])) && (is_numeric($b[0]["raw"]["dateOfBirth"])))
		{
			$aday = (int)date("d", $a[0]["raw"]["dateOfBirth"]);
			$bday = (int)date("d", $b[0]["raw"]["dateOfBirth"]);
			if ($aday == $bday) 
			{
				$ayear = (int)date("Y", $a[0]["raw"]["dateOfBirth"]);
				$byear = (int)date("Y", $b[0]["raw"]["dateOfBirth"]);
				if ($ayear == $byear) 
				{
					return 0;
				}
				return ($ayear < $byear) ? 1 : -1;
			}
			return ($aday < $bday) ? 1 : -1;
		}
	}
	return 0;
}
?>
<div class="<?php echo $this->class; ?> block"<?php echo $this->cssID; ?><?php if ($this->style): ?> style="<?php echo $this->style; ?>"<?php endif; ?>>
<?php if ($this->headline): ?>

<<?php echo $this->hl; ?>><?php echo $this->headline; ?></<?php echo $this->hl; ?>>
<?php endif; ?>

<?php if (count($this->filters)): ?>
<div class="list_search">
<form action="<?php echo $this->action; ?>" method="get">
<div class="formbody">
<input type="hidden" name="order_by" value="<?php echo $this->order_by; ?>" />
<input type="hidden" name="sort" value="<?php echo $this->sort; ?>" />
<input type="hidden" name="per_page" value="<?php echo $this->per_page; ?>" />
<?php for ($i = 0; $i < $this->filtercount; $i++): ?>
<select name="f<?php echo $i; ?>" id="ctrl_filter_<?php echo $i; ?>" class="select">
	<option value="-1"><?php echo $this->select_filter; ?></option>
<?php foreach ($this->filters as $idx => $filter): ?>
	<option <?php if (strlen($this->filter[$i]) && ($this->filter[$i] == $idx)) echo ' selected="selected"'; ?>value="<?php echo $filter[0]; ?>"><?php echo $filter[1]; ?></option>
<?php endforeach; ?>	
</select>
<?php endfor; ?>
<input type="submit" class="submit" value="<?php echo $this->filter_label; ?>" />
</div>
</form>
</div>
<?php endif; ?>
<?php if ($this->show_searchfield): ?>
<div class="list_search">
<form action="<?php echo $this->action; ?>" method="get">
<div class="formbody">
<input type="hidden" name="order_by" value="<?php echo $this->order_by; ?>" />
<input type="hidden" name="sort" value="<?php echo $this->sort; ?>" />
<input type="hidden" name="per_page" value="<?php echo $this->per_page; ?>" />
<?php for ($i = 0; $i < $this->filtercount; $i++): ?>
<input type="hidden" name="f<?php echo $i; ?>" value="<?php echo $this->filter[$i]; ?>" />
<?php endfor; ?>
<select name="search" class="select">
<?php echo $this->search_fields; ?>
</select>
<input type="text" name="for" class="text" value="<?php echo $this->for; ?>" />
<input type="submit" class="submit" value="<?php echo $this->search_label; ?>" />
</div>
</form>
</div>
<?php if ($this->show_searchfield == 2): ?>
<script type="text/javascript">
	function setSearchFields()
	{
		var req = new Request({
			method: 'get',
			url: 'SimpleAjax.php',
			data: { 'module' : 'memberlist', 'field' : $('ctrl_search').value },
			onComplete: function(response) {
				var search_ctrl = $('ctrl_search');
				search_ctrl.getAllNext().each(function(el) {
					el.dispose();
				});
				var result = JSON.decode(response);
				var relations = new Element('select', { 'id' : 'ctrl_relation', 'class' : 'select', 'name' : 'relation'});
				result['relations'].each(function(item){
						var option = new Element('option', { 'value' : item.key }).set('text', item.value);
						if ('<?php echo $this->search; ?>' == $('ctrl_search').value)
						{
							if ('<?php echo $this->relation; ?>' == item.key)
							{
								option.set('selected', 'selected');
							}
						}
						option.inject(relations);
				});
				relations.inject($('ctrl_search'), 'after');
				var ctrl_for;
				var last_element = relations;
				var label_for = new Element('label', { 'for' : 'ctrl_for', 'class' : 'invisible', 'id' : 'label_for'}).set('text', '<?php echo $this->keywords_label; ?>');
				last_element = label_for;
				label_for.inject(relations, 'after');
				if (result['field'].type == 'text')
				{
					var val = '';
					if ('<?php echo $this->search; ?>' == $('ctrl_search').value)
					{
						val = '<?php echo $this->for; ?>';
					}
					ctrl_for = new Element('input', { 'type' : 'text', 'id' : 'ctrl_for', 'value' : val, 'name' : 'for'});
					ctrl_for.inject(label_for, 'after');
					last_element = ctrl_for;
				}
				else if (result['field'].type == 'select')
				{
					ctrl_for = new Element('select', { 'id' : 'ctrl_for', 'class' : 'select', 'name' : 'for'});
					result['field'].options.each(function(item){
							var option = new Element('option', { 'value' : item.key}).set('text', item.value);
							if ('<?php echo $this->search; ?>' == $('ctrl_search').value)
							{
								if ('<?php echo $this->for; ?>' == item.key)
								{
									option.set('selected', 'selected');
								}
							}
							option.inject(ctrl_for);
					});
					ctrl_for.inject(label_for, 'after');
					last_element = ctrl_for;
				}
				var button = new Element('input', {'type' : 'submit', 'class' : 'submit', 'id' : 'button_search', 'value' : '<?php echo $this->search_label; ?>'});
				button.inject(last_element, 'after');
				var resetButton = new Element('input', {'type' : 'submit', 'class' : 'submit', 'id' : 'button_reset', 'name' : 'reset', 'value' : '<?php echo $this->reset_label; ?>'});
				resetButton.inject(button, 'after');
			}
		}).send();
	}
		
	window.addEvent('domready', function() {
		$('ctrl_search').addEvent('change', function(e) {
			e.stop();
			setSearchFields();
		});
		setSearchFields();
	});

</script>
<?php endif; ?>
<?php endif; ?>
<?php if ($this->per_page): ?>

<div class="list_per_page">
<form action="<?php echo $this->action; ?>" method="get">
<div class="formbody">
<input type="hidden" name="order_by" value="<?php echo $this->order_by; ?>" />
<input type="hidden" name="sort" value="<?php echo $this->sort; ?>" />
<input type="hidden" name="search" value="<?php echo $this->search; ?>" />
<?php for ($i = 0; $i < $this->filtercount; $i++): ?>
<input type="hidden" name="f<?php echo $i; ?>" value="<?php echo $this->filter[$i]; ?>" />
<?php endfor; ?>
<input type="hidden" name="for" value="<?php echo $this->for; ?>" />
<select name="per_page" class="select">
  <option value="10"<?php if ($this->per_page == 10): ?> selected="selected"<?php endif; ?>>10</option>
  <option value="20"<?php if ($this->per_page == 20): ?> selected="selected"<?php endif; ?>>20</option>
  <option value="30"<?php if ($this->per_page == 30): ?> selected="selected"<?php endif; ?>>30</option>
  <option value="50"<?php if ($this->per_page == 50): ?> selected="selected"<?php endif; ?>>50</option>
  <option value="100"<?php if ($this->per_page == 100): ?> selected="selected"<?php endif; ?>>100</option>
  <option value="250"<?php if ($this->per_page == 250): ?> selected="selected"<?php endif; ?>>250</option>
  <option value="500"<?php if ($this->per_page == 500): ?> selected="selected"<?php endif; ?>>500</option>
</select>
<input type="submit" class="submit" value="<?php echo $this->per_page_label; ?>" />
</div>
</form>
</div>
<?php endif; ?>

<table cellpadding="0" cellspacing="0" class="all_records" summary="">
<thead>
  <tr>
<?php foreach ($this->thead as $col): ?>
    <th class="head<?php echo $col['class']; ?>"><a href="<?php echo $col['href']; ?>" title="<?php echo $col['title']; ?>"><?php echo $col['link']; ?></a></th>
<?php endforeach; ?>
    <th class="head col_last">&nbsp;</th>
  </tr>
</thead>
<tbody>
<?php $month = date("m", time()); ?>
<?php if (is_array($this->tbody)) 
{
	$arr =& $this->tbody;
	uasort($arr, (strcmp($this->sort, "asc") == 0) ? "datesortasc" : "datesortdesc"); 
	$this->tbody = $arr;
}
?>
<?php $rowcount = 0; ?>
<?php foreach ($this->tbody as $class=>$row): ?>
<?php if (is_numeric($row[0]["raw"]["dateOfBirth"]) && strcmp($month, date("m", $row[0]["raw"]["dateOfBirth"])) == 0): ?>
<?php $rowcount++; ?>
  <tr class="<?php echo "row_" . $rowcount . " "; echo ($rowcount % 2 == 0) ? "even" : "odd" ?>">
<?php foreach ($row as $col): ?>
<?php if ($col['field'] == 'username'): ?>
    <td class="body <?php echo $col['class']; ?>"><a href="<?php echo $this->url; ?>show=<?php echo $col['id']; ?>"><?php echo $col['content']; ?></a></td>
<?php else: ?>
    <td class="body <?php echo $col['class']; ?>"><?php echo str_replace("\n", '<br />', $col['content']); ?></td>
<?php endif; ?>
<?php endforeach; ?>
    <td class="body <?php echo $this->col_last; ?> col_last">
<?php if (strlen($col['jumpTo'])): ?>
			<a href="<?php echo $col['jumpTo']; ?>"><img src="system/modules/xtmembers/html/details.gif" alt="" /></a>
<?php else: ?>
			<a href="<?php echo $this->url; ?>show=<?php echo $col['id']; ?>"><img src="system/modules/xtmembers/html/details.gif" alt="" /></a>
<?php endif; ?>
		</td>
  </tr>
<?php endif; ?>
<?php endforeach; ?>
<?php if ($rowcount == 0): ?>
	<tr><td></td></tr>
<?php endif; ?>
</tbody>
</table>
<?php echo $this->pagination; ?>

</div>
